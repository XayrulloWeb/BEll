# Руководство по Системе Аутентификации

## Обзор

Система управления школьными звонками теперь включает полную систему аутентификации с JWT-токенами, ролевой моделью и мульти-арендностью.

## Архитектура Аутентификации

### Backend (Сервер)
- **JWT токены** для безопасной аутентификации
- **bcrypt** для хеширования паролей
- **Middleware** для проверки токенов и ролей
- **SQLite** база данных с таблицей пользователей

### Frontend (Клиент)
- **Zustand** store для управления состоянием аутентификации
- **Persist** для сохранения сессии в localStorage
- **Защищенные маршруты** с автоматическим редиректом
- **UI компоненты** для входа и регистрации

## Роли Пользователей

### Admin (Администратор школы)
- Доступ только к данным своей школы
- Полное управление расписаниями и звонками
- Не может создавать других пользователей

### Superadmin (Супер-администратор)
- Доступ ко всем школам в системе
- Может создавать пользователей для любой школы
- Расширенные права доступа

## API Endpoints

### Аутентификация
- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/register` - Регистрация нового пользователя

### Защищенные Endpoints
Все остальные API endpoints теперь требуют аутентификации:
- `GET /api/data` - Получение данных школы
- `POST /api/schedules` - Создание расписания
- `POST /api/settings/activeSchedule` - Установка активного расписания
- `POST /api/bells` - Создание звонка
- `PUT /api/bells/:id` - Обновление звонка
- `DELETE /api/bells/:id` - Удаление звонка

## Тестовые Данные

### Готовый пользователь
- **Логин:** admin
- **Пароль:** admin123
- **Роль:** admin
- **Школа:** school_test_001

## Использование

### 1. Запуск Системы
```bash
# Сервер (порт 4000)
cd server
npm run dev

# Клиент (порт 5173)
cd client
npm run dev
```

### 2. Первый Вход
1. Откройте http://localhost:5173
2. Используйте тестовые данные: admin / admin123
3. Или зарегистрируйте нового пользователя

### 3. Регистрация Нового Пользователя
1. Перейдите на вкладку "Регистрация"
2. Заполните форму:
   - Имя пользователя (уникальное)
   - Пароль
   - ID школы (school_test_001)
   - Роль (admin/superadmin)

## Безопасность

### JWT Токены
- Срок действия: 24 часа
- Автоматическое обновление при активности
- Безопасное хранение в localStorage

### Пароли
- Хеширование с bcrypt (10 раундов)
- Минимальная длина: 6 символов
- Проверка на сервере

### Защита Маршрутов
- Все API запросы проверяют токен
- Автоматический logout при истечении токена
- Изоляция данных по школам

## Структура Базы Данных

### Таблица users
```sql
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    school_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK (role IN ('admin', 'superadmin')),
    FOREIGN KEY (school_id) REFERENCES schools(id) ON DELETE CASCADE
);
```

## Устранение Неполадок

### Проблема: "Сессия истекла"
- **Решение:** Войдите в систему заново
- **Причина:** JWT токен истек

### Проблема: "Неверные учетные данные"
- **Решение:** Проверьте логин и пароль
- **Причина:** Неправильный username или password

### Проблема: "Доступ запрещен"
- **Решение:** Убедитесь, что у вас есть права доступа
- **Причина:** Недостаточные права роли

## Разработка

### Добавление Новых Ролей
1. Обновите enum в `database.service.ts`
2. Добавьте проверки в `auth.middleware.ts`
3. Обновите типы в `useAuthStore.ts`

### Расширение Прав Доступа
1. Создайте новые middleware функции
2. Примените к нужным endpoints
3. Обновите UI для отображения прав

## Заключение

Система аутентификации полностью интегрирована и готова к использованию. Все существующие функции работают с учетом безопасности и изоляции данных между школами.
